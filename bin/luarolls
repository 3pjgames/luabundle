#!/bin/bash

set -e
[ -n "$DEBUG" ] && set -x

LUAROLL_LOCAL=.
LUAROLL_SKYNET_ROOT=skynet
LUAROLL_SKYNET_REPO=git@gitlab.3pjgames.com:github/skynet.git
LUAROLL_TREE=rolls
LUAROLL_BUILD_SKYNET=

skynet() {
  LUAROLL_BUILD_SKYNET=1
  if ! [ -d "$LUAROLL_SKYNET_ROOT" ]; then
    git clone "$LUAROLL_SKYNET_REPO" "$LUAROLL_SKYNET_ROOT"
  else
    git -C "$LUAROLL_SKYNET_ROOT" fetch --force
  fi
  git -C "$LUAROLL_SKYNET_ROOT" checkout --force "origin/${1:-HEAD}"
}

rock() {
  local rock_module="$1"
  local local_rock_spec="$LUAROLL_LOCAL/$rock_module"
  mkdir -p "$LUAROLL_TREE"
  if [ -f "$local_rock_spec" ]; then
    shift
    luarocks install "$local_rock_spec" "$@"
  else
    luarocks install "$@"
  fi
}

_skynet_build() {
  pushd "$LUAROLL_SKYNET_ROOT"
  case "$(uname)" in
    Linux)
      make linux ;;
    Darwin)
      make macosx ;;
    *)
      echo "skynet is not supported in $(uname)"
      exit 2
      ;;
  esac
  popd
}

_resolve_local() {
  local bash_source="$1"
  local remember_pwd="$(pwd)"
  if [ -L "$bash_source" ]; then
    bash_source="$(readlink "$bash_source")"
  fi
  cd "$(dirname "$bash_source")"
  cd ..
  LUAROLL_LOCAL="$(pwd)"
  cd "$remeber_pwd"
}

_install() {
  eval "$(cat Luarollfile)"

  if [ -n "$LUAROLL_BUILD_SKYNET" ]; then
    _skynet_build
  fi
}

_resolve_local "$0"
sed -e "s;\./rolls;$(pwd)/rolls;g" "$LUAROLL_LOCAL/config.lua" > .luarolls.lua
export LUAROCKS_CONFIG="$(pwd)/.luarolls.lua"

case "x$1" in
  xpath)
    luarocks path
    echo "export PATH=\"$(pwd)/rolls/bin:$PATH\""
    ;;
  xupgrade)
    git -C "$LUAROLL_LOCAL" pull
    ;;
  x|xinstall)
    _install
    ;;
  *)
    echo "luarolls [install|path|help]"
    ;;
esac
